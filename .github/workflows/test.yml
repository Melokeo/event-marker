name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        python-version: ["3.10"]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    # Linux: Install system dependencies for Qt
    - name: Install system dependencies (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libxcb-xinerama0 \
          libxcb-icccm4 \
          libxcb-image0 \
          libxcb-keysyms1 \
          libxcb-randr0 \
          libxcb-render-util0 \
          libxcb-shape0 \
          libxcb-cursor0 \
          libxkbcommon-x11-0 \
          libxkbcommon0 \
          libdbus-1-3 \
          libegl1 \
          libfontconfig1 \
          libgl1 \
          libglib2.0-0 \
          libgstreamer-plugins-base1.0-0 \
          libgstreamer1.0-0 \
          libpulse0 \
          x11-utils \
          xvfb

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    # Generate test video if it doesn't exist
    - name: Generate test video
      run: |
        python -c "
        import cv2
        import numpy as np
        from pathlib import Path
        
        # Create tests/assets directory if it doesn't exist
        assets_dir = Path('tests/assets')
        assets_dir.mkdir(parents=True, exist_ok=True)
        
        # Video parameters
        output_path = assets_dir / 'frame_counter_11988_4200.mp4'
        if not output_path.exists():
            width, height = 640, 480
            fps = 30.0
            duration = 5  # 5 seconds
            
            fourcc = cv2.VideoWriter_fourcc(*'mp4v')
            out = cv2.VideoWriter(str(output_path), fourcc, fps, (width, height))
            
            for frame_num in range(int(fps * duration)):
                # Create frame with frame number
                frame = np.zeros((height, width, 3), dtype=np.uint8)
                text = f'Frame: {frame_num}'
                cv2.putText(frame, text, (50, height//2), 
                           cv2.FONT_HERSHEY_SIMPLEX, 1, (255, 255, 255), 2)
                out.write(frame)
            
            out.release()
            print(f'Created test video: {output_path}')
        else:
            print(f'Test video already exists: {output_path}')
        " || echo "OpenCV not available, skipping video generation"

    # Run tests on Linux with xvfb (virtual display)
    - name: Run tests (Linux)
      if: runner.os == 'Linux'
      env:
        QT_QPA_PLATFORM: offscreen
        DISPLAY: ':99'
      run: |
        Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
        sleep 3
        pytest tests/ -v --tb=short --junit-xml=test-results-${{ matrix.os }}-${{ matrix.python-version }}.xml

    # Run tests on Windows/macOS
    - name: Run tests (Windows/macOS)
      if: runner.os != 'Linux'
      env:
        QT_QPA_PLATFORM: offscreen
      run: |
        pytest tests/ -v --tb=short --junit-xml=test-results-${{ matrix.os }}-${{ matrix.python-version }}.xml

    # Upload test results
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ matrix.os }}-${{ matrix.python-version }}
        path: test-results-*.xml

    # Generate coverage report (only on Ubuntu)
    - name: Generate coverage report
      if: matrix.os == 'ubuntu-latest'
      env:
        QT_QPA_PLATFORM: offscreen
        DISPLAY: ':99'
      run: |
        Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
        sleep 3
        pip install pytest-cov
        pytest tests/ --cov=src --cov-report=xml --cov-report=html

    - name: Upload coverage to Codecov
      if: matrix.os == 'ubuntu-latest'
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

    - name: Upload coverage HTML
      if: matrix.os == 'ubuntu-latest'
      uses: actions/upload-artifact@v4
      with:
        name: coverage-html
        path: htmlcov/

  test-summary:
    needs: test
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: Check test results
      run: echo "Tests completed"
